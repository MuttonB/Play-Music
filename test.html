<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

</head>
<audio src="http://music.163.com/song/media/outer/url?id=28838219.mp3" controls></audio>
<div class="contantText">
    <div class="lrcList"></div>
</div>

<body>
    <script>
        var audio = document.querySelector("audio")
        var lrc_list = document.querySelector(".lrcList")
        var contanter = document.querySelector(".contantText")
        function setLrc() {
            var lrcContent = ''
            var result = []
            $.ajax({
                url: "https://music.163.com/api/song/media?id=28838219",
                dataType: "jsonp",
                success: function (data) {
                    lrcContent = data.lyric
                    lrcContent = lrcContent.split("\n\n")
                    for (let i = 0; i < lrcContent.length; i++) {
                        const str = lrcContent[i];
                        const parts = str.split("]");
                        const timeStr = parts[0].substring(1);
                        const obj = {
                            time: parseTime(timeStr),
                            words: parts[1]
                        };
                        result.push(obj);
                    }
                    createElements()
                }
            });

            function parseTime(timeStr) {
                const parts = timeStr.split(":");
                return +parts[0] * 60 + +parts[1]; // +一元运算符转数字
            }

            function findIndex() {
                const curTime = audio.currentTime;
                for (let i = 0; i < result.length; i++) {
                    if (curTime < result[i].time) {
                        return result[i - 1].words ? i - 1 : i - 2;
                    }
                }
                return result.length - 1;
            }

            function createElements() {
                const frag = document.createDocumentFragment(); // 文档片段
                for (let i = 0; i < result.length; i++) {
                    const li = document.createElement("li");
                    li.textContent = result[i].words;
                    frag.appendChild(li);
                }
                lrc_list.appendChild(frag);
            }

            function setOffset() {
                const containerHight = contanter.clientHeight;
                const liHight = lrc_list.children[0].clientHeight;
                const maxOffset = lrc_list.clientHeight - containerHight;
                const index = findIndex();
                let offset = liHight * index + liHight / 2 - containerHight / 2;
                if (offset < 0) {
                    offset = 0;
                }
                if (offset > maxOffset) {
                    offset = maxOffset;
                }
                lrc_list.style.transform = `translateY(-${offset}px)`;
                let li = lrc_list.querySelector(".active");
                if (li) {
                    li.classList.remove("active");
                }
                li = lrc_list.children[index];
                if (li) {
                    li.classList.add("active");
                }
            }
            audio.addEventListener("timeupdate", setOffset);
        }
        setLrc()
    </script>
</body>

</html>